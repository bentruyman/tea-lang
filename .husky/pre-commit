if ! command -v bd >/dev/null 2>&1; then
  echo "Warning: bd command not found, skipping pre-commit flush" >&2
  exit 0
fi

if ! bd sync --flush-only >/dev/null 2>&1; then
  echo "Error: Failed to flush bd changes to JSONL" >&2
  echo "Run 'bd sync --flush-only' manually to diagnose" >&2
  exit 1
fi

git add .beads/issues.jsonl 2>/dev/null || true

STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)
if [ -n "$STAGED_RS_FILES" ]; then
  cargo fmt --all
  echo "$STAGED_RS_FILES" | xargs git add
fi

bunx lint-staged
